apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: collector-workloads-securitycontext
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: require-hardened-securitycontext-on-collector-workloads
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - DaemonSet
                - StatefulSet

      preconditions:
        all:
          - key: "{{ request.object.spec.template.metadata.labels.\"app.kubernetes.io/name\" }}"
            operator: Equals
            value: opentelemetry-collector

      validate:
        message: "Collector workloads must run with hardened container securityContext."
        pattern:
          spec:
            template:
              spec:
                containers:
                  - name: "?*"
                    securityContext:
                      privileged: false
                      readOnlyRootFilesystem: true
                      allowPrivilegeEscalation: false
                      runAsNonRoot: true
                      runAsUser: 10001
                      runAsGroup: 10001
                      seccompProfile:
                        type: RuntimeDefault
                      capabilities:
                        drop:
                          - ALL
