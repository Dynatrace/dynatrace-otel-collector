extensions:
  health_check:
    endpoint: 0.0.0.0:13133

receivers:
  k8sobjects:
    objects:
      - name: namespaces
        mode: pull
      - name: nodes
        mode: pull
      - name: events
        mode: watch
        namespaces: [${env:NAMESPACE}]
      - name: pods
        mode: watch
        namespaces: [${env:NAMESPACE}]
        label_selector: app in (busybox)
      - name: deployments
        mode: watch
        namespaces: [${env:NAMESPACE}]
        label_selector: app in (busybox)

processors:
  transform:
    error_mode: ignore
    log_statements:
      - context: log # pulled objects
        conditions:
          - IsMap(log.body) and log.body["object"] == nil
        statements:
          - flatten(log.body, resolveConflicts=true)
      - context: log # watched objects
        conditions:
          - IsMap(log.body) and log.body["object"] != nil
        statements:
          - set(log.body, log.body["object"])
          - flatten(log.body, resolveConflicts=true)
      - context: log # creating message attribute in log body for objects that do not have it
        conditions:
          - IsMap(log.body) and log.body["message"] == nil
        statements:
          - set(log.body["message"], Concat(["Kind - ", log.body["kind"], "; Name - ", log.body["metadata.name"], "; Namespace - ", log.body["metadata.namespace"]], ""))
        
exporters:
  otlphttp:
    endpoint: ${env:DT_ENDPOINT}
    headers:
      Authorization: "Api-Token ${env:API_TOKEN}"
  debug:
    verbosity: detailed

service:
  extensions: [health_check]
  pipelines:
    logs:
      receivers: [k8sobjects]
      processors: [transform]
      exporters: [otlphttp]
